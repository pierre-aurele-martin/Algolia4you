/*! algolia-4-you 24-09-2017 */
function Algolia(a){$this=a,this.checkIndex=function(){var a=this.cheatSystem();$.ajax({data:{action:"algolia/checkIndex",indexName:a},success:function(a,b,c){"object"==typeof a&&"success"in a?!0===a?$("#force-reindex").is(":checked")?$this.algolia.deleteIndex():(tcons("This site already has an Algolia index !"),$this.algolia.startSearch()):!1===a&&$this.fetchCategories($this):(tcons("An error happened in checking Algolia index."),cons(a))}})},this.cheatSystem=function(){var a;switch($this.system){case"woocommerce":a="WC-"+$this.url;break;case"shopify":a="SY-"+$this.url;break;default:a=$this.url}return a},this.createIndex=function(){var a=this.cheatSystem();$.ajax({type:"POST",data:{action:"algolia/createIndex",indexName:a,batch:JSON.stringify($this.batch)},success:function(a,b,c){if("object"==typeof a&&"success"in a){tcons("Congratulations, your products are now in an Algolia index ! "),tcons("You'll see your new search engine in a few seconds...");setTimeout(function(){$this.algolia.startSearch()},3500)}else tcons(a.error),cons(a),cons(b),cons(c)}})},this.deleteIndex=function(){var a=this.cheatSystem();$.ajax({type:"POST",data:{action:"algolia/deleteIndex",indexName:a},success:function(a,b,c){if("object"==typeof a&&"error"in a)tcons(a.error),cons(a),cons(b),cons(c);else{if(!("object"==typeof a&&"success"in a))return tcons("An error happened while trying to delete the index. Aborted."),!1;tcons("The previous index just get erased."),$this.fetchCategories($this)}}})},this.startSearch=function(){var a=this.cheatSystem();document.location.href="algolia.html#"+a}}function Search(){this.hashChange=function(a){var b='<input id="search-input" class="form-control" placeholder="Search on '+a.substr(3).capitalize()+'"  aria-label="Search on '+a.substr(3).capitalize()+'" >';$("#ecommerce-form").html(b),this.initAutoComplete(a),this.initInstantSearch(a)},this.initInstantSearch=function(a){var b=instantsearch({appId:appId,apiKey:apiKey,indexName:a,urlSync:!1,hitsPerPage:20});b.addWidget(instantsearch.widgets.searchBox({container:"#search-input",poweredBy:!0,searchOnEnterKeyPressOnly:!1})),b.addWidget(instantsearch.widgets.infiniteHits({container:"#hits",templates:{item:$("#hit-template").html(),empty:'We didn\'t find any results for the search <em>"{{query}}"</em>'},hitsPerPage:3})),b.addWidget(instantsearch.widgets.hierarchicalMenu({collapsible:{collapsed:window.innerWidth<=1200},container:"#hierarchical-categories",attributes:["hierarchicalCategories.lvl0","hierarchicalCategories.lvl1","hierarchicalCategories.lvl2","hierarchicalCategories.lvl3"],templates:{header:'<h4><span class="oi oi-project"></span> Categories tree:  </h4>',item:function(a){return'> <a class="ais-hierarchical-menu--link" href="'+a.url+'">'+a.label+' <span class="ais-hierarchical-menu--count"> ('+a.count+") </span></a>"}}})),b.addWidget(instantsearch.widgets.refinementList({collapsible:{collapsed:window.innerWidth<=1200},container:"#brands",attributeName:"brand",operator:"or",limit:10,templates:{header:'<h4><span class="oi oi-list"></span> Brand(s) filter:  </h4>'}})),b.addWidget(instantsearch.widgets.rangeSlider({container:"#price",attributeName:"price",templates:{header:'<h4> <span class="oi oi-dollar"></span> Price range: </h4>'},tooltips:{format:function(a){return"$"+Math.round(a).toLocaleString()}}})),b.addWidget(instantsearch.widgets.clearAll({container:"#clear-all",templates:{link:'<span class="oi oi-circle-x"></span> Clear filters'},autoHideContainer:!0})),b.addWidget(instantsearch.widgets.stats({container:"#stats-container"})),b.start()},this.initAutoComplete=function(a){cons("Autocomplete is init for index ==> "+a);var b=algoliasearch(appId,apiKey),c=b.initIndex(a);$("#search-input").autocomplete({hint:!1,debug:!0},[{source:$.fn.autocomplete.sources.hits(c,{hitsPerPage:5}),displayKey:"name",templates:{suggestion:function(a){return"<span>"+a._highlightResult.name.value+"</span>"}}}]).on("autocomplete:selected",function(a,b,c){})}}function Site(){this.inProgress=!1,this.url=!1,this.maxProducts=500,this.maxPerCat=0,this.extraCredit=0,this.maxAsync=3,this.cats=[],this.cntProducts=0,this.batch=[],this.trackPromises=0,this.algolia=new Algolia(this),this.setUrl=function(a){a=a.replace("http://","").replace("https://","").replace("www.","");var b=/^([a-zA-Z0-9][a-zA-Z0-9-]{1,61}[a-zA-Z0-9]\.[a-zA-Z]{2,}(\.[a-zA-Z]{2,})?)\/?(\S*)/;if(!1===b.test(a))$("#url-addon-1, #url-addon-2").css("background-color","#f77171"),this.url=!1;else{var c=a.match(b);this.url=c[1],$("#url-addon-1, #url-addon-2").css("background-color","#a6f3a6"),inputs.attr("readonly",!0),this.setSystem()}},this.setSystem=function(){$.ajax({data:{action:"scrapper/checkSystem",url:this.url},success:function(a,b,c){if("error"in a)return tcons("Erreur => ".data.error),!1;tcons("Système détecté : "+a.success),site.system=a.success,site.conf=conf[site.system],site.algolia.checkIndex()},error:function(a,b,c){return cons("error"),cons(a),cons(b),cons(c),!1}})},this.fetchCategories=function(a){tcons("Starting to fetch your categories, depending on your server, it could take a few minutes."),tcons("Here is a video to watch if you want, you'll be redirect as soon as we're done !"),tcons('<div class="" style="position: absolute; right: 0; bottom:2em;"><iframe class="embed-responsive-item" src="https://www.youtube-nocookie.com/embed/vGXJANUkOPw" frameborder="0" allowfullscreen></iframe></div>'),$.ajax({data:{action:"scrapper/fetchCats",url:a.url,system:a.system},success:function(b,c,d){function e(a,b){"object"==typeof b&&$.each(b,function(b,c){1===Object.keys(c).length&&"url"in c?a.catsInArray.push({name:b,url:c.url}):e(a,c)})}function f(a){Object.keys(a).forEach(function(b){a[b]&&"object"==typeof a[b]&&!Array.isArray(a[b])&&(a[b].categories=(a.categories||[]).concat(b),f(a[b]))})}if(!("success"in b))return tcons("We were not able to fetch your categories."),cons(b.error),!1;if(a.cats=b.success.cats,catsLength=Object.keys(a.cats).length,catsLength<1)return tcons("No categories were found. We'll stop here unfortunately..."),!1;for(a.catsInArray=[],e(a,a.cats),f(a.cats),tcons(a.catsInArray.length+" cats were found. Now parsing..."),a.maxPerCat=Math.floor(a.maxProducts/a.catsInArray.length),i=0;i<a.maxAsync;i++)a.handlePromisebyWave(a,i)},error:function(a,b,c){return tcons("We were not able to fetch your categories."),cons(a),!1}})},this.handlePromisebyWave=function(a,b){if(b in a.catsInArray){new Promise(function(c,d){var e=Math.floor(a.extraCredit/a.maxAsync),f=a.maxPerCat+e;a.fetchProductsUrl(c,d,a,b,f),a.extraCredit-=e}).then(function(c){a.handlePromisebyWave(a,b+a.maxAsync),a.trackPromises++})}else a.trackPromises===a.catsInArray.length-1&&(tcons("All your products has been fetched."),a.algolia.createIndex())},this.fetchProductsUrl=function(a,b,c,d,e){var f=c.catsInArray[d].name,g=c.catsInArray[d].url;$.ajax({data:{action:"scrapper/fetchCat",system:c.system,url:g,maxPerCat:e}}).then(function(d){function g(c,d){"object"==typeof d&&$.each(d,function(d,e){if(2===Object.keys(e).length&&"url"in e&&f===d){var i=/^http/;if($.each(h,function(a,b){!1===i.test(a)&&(newIndex="http://"+c.url+a,h[newIndex]=b,delete h[a])}),e.products=h,dataLength>0){new Promise(function(a,b){c.fetchProduct(a,b,c,e,f)}).then(function(b){a(!0)}).catch(function(a){tcons("An error append while getting your products. Sorry."),cons(a),b(!1)})}else a(!0)}else"object"!=typeof e||"products"in e||g(c,e)})}if("error"in d)tcons("An error occured while fetching products from your cats."),cons(d),a(!0);else if("success"in d){var h=d.success;dataLength=Object.keys(h).length,c.cntProducts+=dataLength,c.extraCredit+=e-dataLength,tcons('<span id="'+f+'">0</span> / '+dataLength+" products crawled in category "+f),g(c,c.cats)}})},this.fetchProduct=function(a,b,c,d,e){function f(f){$.ajax({data:{action:"scrapper/fetchProduct",system:c.system,url:f},beforeSend:function(){d.products[f]=-1}}).then(function(g){if("success"in g){var h=g.success;if(""!==h.name&&null!==h.name&&""!==h.price&&null!==h.price){var i=d.categories,j="";$.each(i,function(a,b){var c=b.replace(/[^\w\s]/gi," ").capitalize();h.categories=(h.categories||[]).concat(c),h.hierarchicalCategories=h.hierarchicalCategories||{},h.hierarchicalCategories["lvl"+a]=j+c,j+=c+" > "}),h.popularity=!1,h.rating=!1,d.products[f]=h,c.batch.push(h),$("#"+e).text(parseInt($("#"+e).text())+1)}else cons("One product was rejected due to some lack of informations"),d.products[f]={false:!1};c.fetchProduct(a,b,c,d,e)}else tcons("An error occured while trying to get one product. It's not as bad as it look, we continue..."),cons(g),d.products[f]={false:!1},c.fetchProduct(a,b,c,d,e)})}var g=0,h=0;$.each(d.products,function(b,c){0===g&&1===c?(f(b),g++):"object"==typeof c&&++h===Object.keys(d.products).length&&a(!0)})}}function getIndices(){$.ajax({data:{action:"algolia/getIndices"},success:function(a,b,c){if(!("success"in a))return tcons("We were not able to get our indices. Our site is down (not algolia)."),cons(a),!1;var d=$("#menu-dropdown > div.dropdown-menu");d.find(".alg-index").remove(),$.each(a.success.items,function(a,b){d.append('<a class="dropdown-item alg-index" href="algolia.html#'+b.name+'">'+b.realName+"</a>")})},error:function(a,b,c){cons("error"),cons(a),cons(b),cons(c)}})}function cons(a){console.log(a)}function tcons(a){$("#console").append(">"+a+"<br/>"),$("#console-container").scrollTop($("#console-container")[0].scrollHeight)}const appId="653YPGRUJS",apiKey="67aebf7df47999607220ceb259829579";String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)},$.ajaxSetup({url:"back/router.php",dataType:"json",type:"GET"});